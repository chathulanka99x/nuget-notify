name: Check nuget

on:
  workflow_dispatch:
  schedule:
  - cron: '30 3 * * *'


jobs:
  main:
    runs-on: ubuntu-latest
    timeout-minutes: 5 
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: pip install -r bin/requirements.txt

    - name: Run Check
      run: python bin/check.py

    - name: Check if updates file is non-empty
      id: check_updates
      run: |
        if [ -s updates.txt ]; then
          echo "Updates are available"
          cat nuget.txt
          echo "::set-output name=updates_available::true"
        else
          echo "No updates available"
          echo "::set-output name=updates_available::false"
        fi

    - name: Set issue title with current date and time
      id: set_title
      run: |
        # Get current date and time in the format YYYY-MM-DD HH:MM:SS
        title=$(date +"%Y-%m-%d %H:%M:%S")
        echo "Issue title: $title"
        echo "issue_title=$title" >> $GITHUB_ENV

    - name: Create Issue
      if: steps.check_updates.outputs.updates_available == 'true'
      run: |
        gh issue create --title "${{ env.issue_title }}" --body-file ./nuget.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
